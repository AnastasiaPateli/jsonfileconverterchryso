<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenancy Agreement Generator</title>
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .upload-section, .agreements-section {
            margin-bottom: 20px;
        }
        button, input[type="file"] {
            padding: 10px;
            margin: 10px 0;
            cursor: pointer;
            border-radius: 4px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            font-size: 14px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .agreement {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .error {
            color: red;
            margin: 10px 0;
            font-weight: bold;
        }
        .download-all-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .agreement-counter {
            font-size: 14px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f4f4f4;
        }
        @media (max-width: 600px) {
            table {
                font-size: 12px;
            }
            button, input[type="file"] {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="download-all-section">
        <button class="download-all-btn" id="downloadAllBtn" style="display: none;" aria-label="Download all agreements as ZIP">Download All Agreements (ZIP)</button>
        <button class="download-single-btn" id="downloadSingleBtn" style="display: none;" aria-label="Download all agreements as single document">Download Single Document</button>
        <span class="agreement-counter" id="agreementCounter">Agreements: 0</span>
    </div>
    <div class="upload-section">
        <h2>Tenancy Agreement Generator</h2>
        <input type="file" id="jsonFile" accept=".json" aria-label="Upload JSON file">
        <div id="error" class="error" role="alert"></div>
    </div>
    <div class="agreements-section" id="agreements"></div>

    <script>
        const jsonFileInput = document.getElementById('jsonFile');
        const agreementsDiv = document.getElementById('agreements');
        const errorDiv = document.getElementById('error');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const downloadSingleBtn = document.getElementById('downloadSingleBtn');
        const agreementCounter = document.getElementById('agreementCounter');
        let agreementBlobs = [];
        let allAgreementsData = [];

        // Check if required libraries are loaded
        window.addEventListener('load', () => {
            if (!window.docx || !window.saveAs || !window.JSZip) {
                displayError('Required libraries (docx.js, FileSaver.js, or JSZip) failed to load.');
            }
        });

        jsonFileInput.addEventListener('change', handleFileUpload);

        function displayError(message) {
            errorDiv.textContent = message;
            console.error(message);
        }

        function validateJsonStructure(data) {
            if (!data.tin) return 'Missing tenant TIN in JSON data.';
            if (!data.applicant_detail || typeof data.applicant_detail !== 'object') return 'Invalid or missing applicant_detail in JSON data.';
            if (!Array.isArray(data.field_list)) return 'Invalid or missing field_list in JSON data.';
            return null;
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                displayError('No file selected.');
                return;
            }

            try {
                const text = await file.text();
                const data = JSON.parse(text);
                const validationError = validateJsonStructure(data);
                if (validationError) {
                    displayError(validationError);
                    return;
                }
                errorDiv.textContent = '';
                generateAgreements(data, data.tin);
            } catch (error) {
                displayError('Error processing file: ' + error.message);
            }
        }

        function getKaek(propertyList) {
            if (!Array.isArray(propertyList) || propertyList.length === 0) return '-';
            const property = propertyList.find(p => p.kaek && p.kaek !== '');
            return property ? property.kaek : '-';
        }

        function generateAgreements(data, tenantTin) {
            agreementsDiv.innerHTML = '';
            agreementBlobs = [];
            allAgreementsData = [];
            const tenant = data.applicant_detail || {};
            const fields = Array.isArray(data.field_list) ? data.field_list : [];

            if (!fields.length) {
                displayError('No fields found in the JSON data.');
                return;
            }

            const agreementsByTinAndDates = {};
            fields.forEach((field, fieldIndex) => {
                const fieldInfo = field.field_info || {};
                const propertyList = Array.isArray(field.field_property_list) ? field.field_property_list : [];
                const geospatialData = field.field_geospatial_data || {};

                if (!propertyList.length) return;

                propertyList.forEach((property, propIndex) => {
                    const tin = property.tin || `unknown_tin_${Math.random().toString(36).substr(2, 9)}`;
                    const fullName = property.full_name || 'Unknown Owner';
                    if (tin.startsWith('unknown_tin_') || fullName === 'Unknown Owner' || tin === tenantTin) return;

                    const rentalKey = `${tin}_${property.rental_start_date || '-'}_${property.rental_end_date || '-'}`;
                    if (!agreementsByTinAndDates[rentalKey]) {
                        agreementsByTinAndDates[rentalKey] = {
                            owner: {
                                tin: property.tin,
                                full_name: fullName,
                                doy: 'Α Σερρών'
                            },
                            rental_start_date: property.rental_start_date || '-',
                            rental_end_date: property.rental_end_date || '-',
                            fields: []
                        };
                    }
                    agreementsByTinAndDates[rentalKey].fields.push({
                        serial_number: geospatialData.serial_number || '-',
                        community: geospatialData.community_code || 'Unknown',
                        location: fieldInfo.location || 'Unknown',
                        atak: property.atak || '-',
                        kaek: getKaek([property]),
                        other_cartographic_background: fieldInfo.other_cartographic_background || '-',
                        cartographic_background: geospatialData.cartographic_background || '-',
                        area_ha: property.area_participation_atak || '0',
                        rental_start_date: property.rental_start_date || '-',
                        rental_end_date: property.rental_end_date || '-',
                        property_tin: property.tin
                    });
                });
            });

            const agreements = Object.values(agreementsByTinAndDates);
            if (!agreements.length) {
                displayError('No valid agreements generated.');
                downloadAllBtn.style.display = 'none';
                downloadSingleBtn.style.display = 'none';
                agreementCounter.textContent = 'Agreements: 0';
                return;
            }

            agreementCounter.textContent = `Agreements: ${agreements.length}`;
            downloadAllBtn.style.display = agreements.length > 1 ? 'block' : 'none';
            downloadSingleBtn.style.display = 'block';

            agreements.forEach((agreement, index) => {
                const agreementDiv = document.createElement('div');
                agreementDiv.className = 'agreement';
                agreementDiv.innerHTML = `
                    <h3>Agreement ${index + 1} for ${agreement.owner.full_name} (TIN: ${agreement.owner.tin}, ${agreement.rental_start_date} - ${agreement.rental_end_date})</h3>
                    <table>
                        <tr>
                            <th>Α/Α</th>
                            <th>ΚΟΙΝΟΤΗΤΑ (κωδ.)</th>
                            <th>ΤΟΠΟΘΕΣΙΑ</th>
                            <th>Α.Τ.Α.Κ.</th>
                            <th>Κ.Α.Ε.Κ.</th>
                            <th>ΑΡ.ΚΤΗΜ.ΤΕΜ.</th>
                            <th>ΧΑΡΤΟΓΡΑΦΙΚΟ</th>
                            <th>ΕΚΤΑΣΗ (Ha)</th>
                        </tr>
                        ${agreement.fields.map((field, fieldIndex) => `
                            <tr>
                                <td>${fieldIndex + 1}</td>
                                <td>${field.community}</td>
                                <td>${field.location}</td>
                                <td>${field.atak}</td>
                                <td>${field.kaek}</td>
                                <td>${field.other_cartographic_background}</td>
                                <td>${field.cartographic_background}</td>
                                <td>${field.area_ha}</td>
                            </tr>
                        `).join('')}
                    </table>
                    <button class="download-btn" aria-label="Download agreement for ${agreement.owner.full_name}">Download Agreement</button>
                `;
                agreementDiv.querySelector('.download-btn').addEventListener('click', () => generateDocx(agreement, tenant, tenantTin, false));
                generateDocx(agreement, tenant, tenantTin, true);
                allAgreementsData.push({ agreement, tenant, tenantTin });
                agreementsDiv.appendChild(agreementDiv);
            });
        }

        function formatGreekDate(dateStr) {
            if (!dateStr || dateStr === '-') return '-';
            const date = new Date(dateStr);
            return isNaN(date.getTime()) ? '-' : date.toLocaleDateString('el-GR', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        async function generateDocx(agreement, tenant, tenantTin, storeBlob = false) {
            if (!window.docx || !window.saveAs) {
                throw new Error('Required libraries (docx.js or FileSaver.js) are not loaded.');
            }

            const { Document, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, AlignmentType, BorderStyle, Footer } = docx;
            const rentalStartDate = formatGreekDate(agreement.rental_start_date);
            const rentalEndDate = formatGreekDate(agreement.rental_end_date);

            if (rentalStartDate === '-' || rentalEndDate === '-') {
                throw new Error('Invalid rental start or end date.');
            }

            const doc = new Document({
                sections: [{
                    footers: {
                        default: new Footer({
                            children: [
                                new Paragraph({
                                    children: [
                                        new TextRun({
                                            text: `ΥΠΟΣΗΜΕΙΩΣΗ: Το ποσό του μισθώματος δύναται να αναζητηθεί στο Έντυπο Ε3 του μισθωτή, όπως υποβάλλεται στην Ανεξάρτητη Αρχή Δημοσίων Εσόδων (ΑΑΔΕ).`,
                                            size: 18,
                                            font: "Arial"
                                        })
                                    ],
                                    alignment: AlignmentType.JUSTIFIED
                                })
                            ]
                        })
                    },
                    children: [
                        new Paragraph({
                            children: [new TextRun({ text: "ΙΔΙΩΤΙΚΟ ΣΥΜΦΩΝΗΤΙΚΟ ΑΓΡΟΜΙΣΘΩΣΗΣ", bold: true, size: 28, font: "Arial" })],
                            alignment: AlignmentType.CENTER,
                            spacing: { after: 200 }
                        }),
                        new Paragraph({
                            children: [new TextRun({ text: `Σήμερα την ${rentalStartDate} στο Χρυσό οι υπογράφοντες το συμφωνητικό αυτό:`, size: 18, font: "Arial" })],
                            alignment: AlignmentType.JUSTIFIED,
                            spacing: { after: 100 }
                        }),
                        new Paragraph({
                            children: [new TextRun({ text: `1. ο/η ${agreement.owner.full_name}, με Α.Φ.Μ ${agreement.owner.tin}, ως εκμισθωτής και`, size: 18, font: "Arial" })],
                            alignment: AlignmentType.JUSTIFIED,
                            spacing: { after: 100 }
                        }),
                        new Paragraph({
                            children: [new TextRun({ text: `2. ο/η ${tenant.first_name || 'Unknown'} ${tenant.last_name || 'Tenant'} ${tenant.father_name ? 'του ' + tenant.father_name : ''}, με Α.Φ.Μ ${tenantTin}, ως μισθωτής`, size: 18, font: "Arial" })],
                            alignment: AlignmentType.JUSTIFIED,
                            spacing: { after: 100 }
                        }),
                        new Paragraph({
                            children: [new TextRun({ text: "συμφώνησαν από κοινού και αποδέχτηκαν τα εξής:", size: 18, font: "Arial" })],
                            alignment: AlignmentType.JUSTIFIED,
                            spacing: { after: 200 }
                        }),
                        new Paragraph({
                            children: [new TextRun({ text: "1. ΣΤΟΙΧΕΙΑ ΜΙΣΘΩΣΗΣ: Ο εκμισθωτής παραχωρεί στον μισθωτή τη χρήση και εκμετάλλευση του/των αγροτεμαχίου/ων με τα εξής στοιχεία:", size: 18, font: "Arial" })],
                            alignment: AlignmentType.JUSTIFIED,
                            spacing: { after: 100 }
                        }),
                        new Table({
                            width: { size: 100, type: WidthType.PERCENTAGE },
                            borders: {
                                top: { style: BorderStyle.SINGLE, size: 1 },
                                bottom: { style: BorderStyle.SINGLE, size: 1 },
                                left: { style: BorderStyle.SINGLE, size: 1 },
                                right: { style: BorderStyle.SINGLE, size: 1 }
                            },
                            rows: [
                                new TableRow({
                                    children: [
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "Α/Α", font: "Arial", bold: true })], alignment: AlignmentType.CENTER })], width: { size: 5, type: WidthType.PERCENTAGE } }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "ΚΟΙΝΟΤΗΤΑ", font: "Arial", bold: true })], alignment: AlignmentType.CENTER })], width: { size: 15, type: WidthType.PERCENTAGE } }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "ΤΟΠΟΘΕΣΙΑ", font: "Arial", bold: true })], alignment: AlignmentType.CENTER })], width: { size: 20, type: WidthType.PERCENTAGE } }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "Α.Τ.Α.Κ.", font: "Arial", bold: true })], alignment: AlignmentType.CENTER })], width: { size: 15, type: WidthType.PERCENTAGE } }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "Κ.Α.Ε.Κ.", font: "Arial", bold: true })], alignment: AlignmentType.CENTER })], width: { size: 15, type: WidthType.PERCENTAGE } }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "ΑΡ.ΚΤΗΜ.ΤΕΜ.", font: "Arial", bold: true })], alignment: AlignmentType.CENTER })], width: { size: 10, type: WidthType.PERCENTAGE } }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "ΧΑΡΤΟΓΡΑΦΙΚΟ", font: "Arial", bold: true })], alignment: AlignmentType.CENTER })], width: { size: 10, type: WidthType.PERCENTAGE } }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "ΕΚΤΑΣΗ (Ha)", font: "Arial", bold: true })], alignment: AlignmentType.CENTER })], width: { size: 10, type: WidthType.PERCENTAGE } })
                                    ]
                                }),
                                ...agreement.fields.map((field, index) => new TableRow({
                                    children: [
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: (index + 1).toString(), font: "Arial" })], alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: field.community, font: "Arial" })], alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: field.location, font: "Arial" })], alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: field.atak, font: "Arial" })], alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: field.kaek, font: "Arial" })], alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: field.other_cartographic_background, font: "Arial" })], alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: field.cartographic_background, font: "Arial" })], alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: field.area_ha.toString(), font: "Arial" })], alignment: AlignmentType.CENTER })] })
                                    ]
                                }))
                            ]
                        }),
                        new Paragraph({
                            children: [new TextRun({ text: `2. ΔΙΑΡΚΕΙΑ ΜΙΣΘΩΣΗΣ: Η μίσθωση αρχίζει από ${rentalStartDate} και λήγει την ${rentalEndDate} σύμφωνα με το άρθρο 620 ΑΚ, με δυνατότητα παράτασης κατόπιν συμφωνίας.`, size: 18, font: "Arial" })],
                            alignment: AlignmentType.JUSTIFIED,
                            spacing: { before: 200, after: 100 }
                        }),
                        new Paragraph({
                            children: [new TextRun({ text: "3. ΜΙΣΘΩΜΑ: Το μίσθωμα είναι ποσοστιαίο % και ορίζεται όπως δηλώνεται ως δαπάνη στο Έντυπο Ε3 του μισθωτή. Το μίσθωμα για τον εκμισθωτή δεν μπορεί να είναι μικρότερο από τα τεκμαρτά εισοδήματα, όπως ορίζονται στο άρθρο 40 του Ν. 4172/2013 (ΦΕΚ) και δηλώνεται στο Έντυπο Ε2 της ΑΑΔΕ. Σε περίπτωση δωρεάν παραχώρησης (χρησιδανείου), π.χ. από γονέα σε τέκνο, σύζυγο σε σύζυγο ή αμοιβαία ανταλλαγή χρήσης, η παραχώρηση γίνεται δωρεάν ως χρησιδάνειο (άρθρο 810 ΑΚ), χωρίς χρηματικό ή άλλο αντάλλαγμα, και δεν υπολογίζεται τεκμαρτό εισόδημα, εφόσον το αγροτεμάχιο χρησιμοποιείται για αγροτική δραστηριότητα (άρθρο 39 παρ. 4 Ν. 4172/2013). Αλλιώς, το τεκμαρτό εισόδημα είναι 3% της αντικειμενικής αξίας.", size: 18, font: "Arial" })],
                            alignment: AlignmentType.JUSTIFIED,
                            spacing: { after: 100 }
                        }),
                        new Paragraph({
                            children: [new TextRun({ text: "4. ΣΚΟΠΟΣ ΜΙΣΘΩΣΗΣ: Η μίσθωση συνάπτεται με σκοπό την καλλιέργεια του/των αγροτεμαχίου/ων από τον μισθωτή για την εκτέλεση γεωργικών δραστηριοτήτων, σύμφωνα με την ισχύουσα νομοθεσία. Επιπλέον, η μίσθωση παρέχει τη δυνατότητα στον μισθωτή να υποβάλει Ενιαία Αίτηση Ενίσχυσης (ΕΑΕ) μέσω του ΟΠΕΚΕΠΕ, για την ενεργοποίηση δικαιωμάτων βασικής ενίσχυσης και συναφών ενισχύσεων της Κοινής Αγροτικής Πολιτικής (ΚΑΠ) 2023-2027, σύμφωνα με τον Καν. ΕΕ 1307/2013 και τον Ν. 4684/2020. Υπεκμίσθωση του αγροτεμαχίου επιτρέπεται μόνο με προηγούμενη έγγραφη συναίνεση του εκμισθωτή, σύμφωνα με το άρθρο 624 ΑΚ.", size: 18, font: "Arial" })],
                            alignment: AlignmentType.JUSTIFIED,
                            spacing: { after: 100 }
                        }),
                        new Paragraph({
                            children: [new TextRun({ text: "5. ΥΠΟΧΡΕΩΣΕΙΣ ΜΙΣΘΩΤΗ - ΚΑΛΗ ΧΡΗΣΗ ΤΟΥ ΜΙΣΘΙΟΥ: Ο μισθωτής υποχρεούται να χρησιμοποιεί το μίσθιο με επιμέλεια, σύμφωνα με τον προορισμό του, και να το διατηρεί σε κατάσταση κατάλληλη για τη συμφωνημένη χρήση.", size: 18, font: "Arial" })],
                            alignment: AlignmentType.JUSTIFIED,
                            spacing: { after: 100 }
                        }),
                        new Paragraph({
                            children: [new TextRun({ text: "6. ΤΕΛΙΚΕΣ ΔΙΑΤΑΞΕΙΣ: Το παρόν συμφωνητικό διαβάστηκε και έγινε αμοιβαία αποδεκτό από τους συμβαλλόμενους. Κάθε συμβαλλόμενος έλαβε ένα (1) όμοιο αντίτυπο, το οποίο έχει πλήρη νομική ισχύ.", size: 18, font: "Arial" })],
                            alignment: AlignmentType.JUSTIFIED,
                            spacing: { after: 200 }
                        }),
                        new Paragraph({
                            children: [new TextRun({ text: "ΟΙ ΣΥΜΒΑΛΛΟΜΕΝΟΙ", bold: true, size: 18, font: "Arial" })],
                            alignment: AlignmentType.CENTER,
                            spacing: { before: 200, after: 100 }
                        }),
                        new Table({
                            width: { size: 100, type: WidthType.PERCENTAGE },
                            borders: { top: { style: BorderStyle.NONE, size: 0 }, bottom: { style: BorderStyle.NONE, size: 0 }, left: { style: BorderStyle.NONE, size: 0 }, right: { style: BorderStyle.NONE, size: 0 } },
                            rows: [
                                new TableRow({
                                    children: [
                                        new TableCell({
                                            width: { size: 50, type: WidthType.PERCENTAGE },
                                            children: [new Paragraph({ children: [new TextRun({ text: `ΘΕΩΡΗΘΗΚΕ ΤΟ ΓΝΗΣΙΟ ΤΗΣ ΥΠΟΓΡΑΦΗΣ\nΕΚΜΙΣΘΩΤΗΣ ${agreement.owner.full_name}\nμε Α.Δ.Τ.: ________________`, size: 18, font: "Arial" })], alignment: AlignmentType.CENTER })]
                                        }),
                                        new TableCell({
                                            width: { size: 50, type: WidthType.PERCENTAGE },
                                            children: [new Paragraph({ children: [new TextRun({ text: `ΘΕΩΡΗΘΗΚΕ ΤΟ ΓΝΗΣΙΟ ΤΗΣ ΥΠΟΓΡΑΦΗΣ\nΜΙΣΘΩΤΗΣ ${tenant.first_name || 'Unknown'} ${tenant.last_name || 'Tenant'} ${tenant.father_name ? 'του ' + tenant.father_name : ''}\nμε Α.Δ.Τ.: ${tenant.identity_number || '-'}`, size: 18, font: "Arial" })], alignment: AlignmentType.CENTER })]
                                        })
                                    ]
                                })
                            ]
                        }),
                        new Paragraph({
                                children: [new TextRun({ text: "                                                        ", size: 18, font: "Arial" })],
                                alignment: AlignmentType.JUSTIFIED,
                                spacing: { after: 200 }
                            }),
                        new Paragraph({
                                children: [new TextRun({ text: "                                                        ", size: 18, font: "Arial" })],
                                alignment: AlignmentType.JUSTIFIED,
                                spacing: { after: 200 }
                            }),
                        new Paragraph({
                                children: [new TextRun({ text: "                                                        ", size: 18, font: "Arial" })],
                                alignment: AlignmentType.JUSTIFIED,
                                spacing: { after: 200 }
                            }),
                        new Paragraph({
                                children: [new TextRun({ text: "                                                        ", size: 18, font: "Arial" })],
                                alignment: AlignmentType.JUSTIFIED,
                                spacing: { after: 200 }
                            }),
                        new Paragraph({
                            children: [new TextRun({ text: "Για το γνήσιο των υπογραφών", size: 18, font: "Arial" })],
                            alignment: AlignmentType.JUSTIFIED,
                            spacing: { before: 200, after: 100 }
                        }),
                        new Paragraph({
                            children: [new TextRun({ text: `ΗΜΕΡΟΜΗΝΙΑ: ${rentalStartDate}`, size: 18, font: "Arial" })],
                            alignment: AlignmentType.JUSTIFIED,
                            spacing: { after: 100 }
                        })
                    ]
                }]
            });

            try {
                const blob = await docx.Packer.toBlob(doc);
                const filename = `Agreement_${agreement.owner.tin}_${agreement.owner.full_name}_${agreement.rental_start_date || 'no_date'}.docx`;
                if (storeBlob) {
                    agreementBlobs.push({ blob, filename });
                } else {
                    saveAs(blob, filename);
                }
            } catch (error) {
                displayError('Error generating document: ' + error.message);
                throw error;
            }
        }

        async function generateSingleDocx() {
            if (!window.docx || !window.saveAs) {
                displayError('Required libraries (docx.js or FileSaver.js) are not loaded.');
                return;
            }

            const { Document, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, AlignmentType, BorderStyle, Footer } = docx;
            const doc = new Document({
                sections: [{
                    footers: {
                        default: new Footer({
                            children: [
                                new Paragraph({
                                    children: [new TextRun({ text: `ΥΠΟΣΗΜΕΙΩΣΗ: Το ποσό του μισθώματος δύναται να αναζητηθεί στο Έντυπο Ε3 του μισθωτή, όπως υποβάλλεται στην Ανεξάρτητη Αρχή Δημοσίων Εσόδων (ΑΑΔΕ).`, size: 18, font: "Arial" })],
                                    alignment: AlignmentType.JUSTIFIED
                                })
                            ]
                        })
                    },
                    children: allAgreementsData.flatMap((data, index) => {
                        const { agreement, tenant, tenantTin } = data;
                        const rentalStartDate = formatGreekDate(agreement.rental_start_date);
                        const rentalEndDate = formatGreekDate(agreement.rental_end_date);

                        if (rentalStartDate === '-' || rentalEndDate === '-') return [];

                        return [
                            new Paragraph({
                                children: [new TextRun({ text: `ΙΔΙΩΤΙΚΟ ΣΥΜΦΩΝΗΤΙΚΟ ΑΓΡΟΜΙΣΘΩΣΗΣ ${index + 1}`, bold: true, size: 28, font: "Arial" })],
                                alignment: AlignmentType.CENTER,
                                spacing: { after: 200 }
                            }),
                            new Paragraph({
                                children: [new TextRun({ text: `Σήμερα την ${rentalStartDate} στο Χρυσό οι υπογράφοντες το συμφωνητικό αυτό:`, size: 18, font: "Arial" })],
                                alignment: AlignmentType.JUSTIFIED,
                                spacing: { after: 100 }
                            }),
                            new Paragraph({
                                children: [new TextRun({ text: `1. ο/η ${agreement.owner.full_name}, με Α.Φ.Μ ${agreement.owner.tin}, Δ.Ο.Υ. ${agreement.owner.doy}, ως εκμισθωτής και`, size: 18, font: "Arial" })],
                                alignment: AlignmentType.JUSTIFIED,
                                spacing: { after: 100 }
                            }),
                            new Paragraph({
                                children: [new TextRun({ text: `2. ο/η ${tenant.first_name || 'Unknown'} ${tenant.last_name || 'Tenant'} ${tenant.father_name ? 'του ' + tenant.father_name : ''}, με Α.Φ.Μ ${tenantTin}, ως μισθωτής`, size: 18, font: "Arial" })],
                                alignment: AlignmentType.JUSTIFIED,
                                spacing: { after: 100 }
                            }),
                            new Paragraph({
                                children: [new TextRun({ text: "συμφώνησαν από κοινού και αποδέχτηκαν τα εξής:", size: 18, font: "Arial" })],
                                alignment: AlignmentType.JUSTIFIED,
                                spacing: { after: 200 }
                            }),
                            new Paragraph({
                                children: [new TextRun({ text: "1. ΣΤΟΙΧΕΙΑ ΜΙΣΘΩΣΗΣ: Ο εκμισθωτής παραχωρεί στον μισθωτή τη χρήση και εκμετάλλευση του/των αγροτεμαχίου/ων με τα εξής στοιχεία:", size: 18, font: "Arial", bold: true })],
                                alignment: AlignmentType.JUSTIFIED,
                                spacing: { after: 100 }
                            }),
                            new Table({
                                width: { size: 100, type: WidthType.PERCENTAGE },
                                borders: {
                                    top: { style: BorderStyle.SINGLE, size: 1 },
                                    bottom: { style: BorderStyle.SINGLE, size: 1 },
                                    left: { style: BorderStyle.SINGLE, size: 1 },
                                    right: { style: BorderStyle.SINGLE, size: 1 }
                                },
                                rows: [
                                    new TableRow({
                                        children: [
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "Α/Α", font: "Arial", bold: true })], alignment: AlignmentType.CENTER })], width: { size: 5, type: WidthType.PERCENTAGE } }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "ΚΟΙΝΟΤΗΤΑ", font: "Arial", bold: true })], alignment: AlignmentType.CENTER })], width: { size: 15, type: WidthType.PERCENTAGE } }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "ΤΟΠΟΘΕΣΙΑ", font: "Arial", bold: true })], alignment: AlignmentType.CENTER })], width: { size: 20, type: WidthType.PERCENTAGE } }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "Α.Τ.Α.Κ.", font: "Arial", bold: true })], alignment: AlignmentType.CENTER })], width: { size: 15, type: WidthType.PERCENTAGE } }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "Κ.Α.Ε.Κ.", font: "Arial", bold: true })], alignment: AlignmentType.CENTER })], width: { size: 15, type: WidthType.PERCENTAGE } }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "ΑΡ.ΚΤΗΜ.ΤΕΜ.", font: "Arial", bold: true })], alignment: AlignmentType.CENTER })], width: { size: 10, type: WidthType.PERCENTAGE } }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "ΧΑΡΤΟΓΡΑΦΙΚΟ", font: "Arial", bold: true })], alignment: AlignmentType.CENTER })], width: { size: 10, type: WidthType.PERCENTAGE } }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "ΕΚΤΑΣΗ (Ha)", font: "Arial", bold: true })], alignment: AlignmentType.CENTER })], width: { size: 10, type: WidthType.PERCENTAGE } })
                                        ]
                                    }),
                                    ...agreement.fields.map((field, index) => new TableRow({
                                        children: [
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: (index + 1).toString(), font: "Arial" })], alignment: AlignmentType.CENTER })] }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: field.community, font: "Arial" })], alignment: AlignmentType.CENTER })] }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: field.location, font: "Arial" })], alignment: AlignmentType.CENTER })] }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: field.atak, font: "Arial" })], alignment: AlignmentType.CENTER })] }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: field.kaek, font: "Arial" })], alignment: AlignmentType.CENTER })] }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: field.other_cartographic_background, font: "Arial" })], alignment: AlignmentType.CENTER })] }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: field.cartographic_background, font: "Arial" })], alignment: AlignmentType.CENTER })] }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: field.area_ha.toString(), font: "Arial" })], alignment: AlignmentType.CENTER })] })
                                        ]
                                    }))
                                ]
                            }),
                            new Paragraph({
                                children: [new TextRun({ text: `2. ΔΙΑΡΚΕΙΑ ΜΙΣΘΩΣΗΣ: Η μίσθωση αρχίζει από ${rentalStartDate} και λήγει την ${rentalEndDate} σύμφωνα με το άρθρο 620 ΑΚ, με δυνατότητα παράτασης κατόπιν συμφωνίας.`, size: 18, font: "Arial", bold: true })],
                                alignment: AlignmentType.JUSTIFIED,
                                spacing: { before: 200, after: 100 }
                            }),
                            new Paragraph({
                                children: [new TextRun({ text: "3. ΜΙΣΘΩΜΑ: Το μίσθωμα είναι ποσοστιαίο % και ορίζεται όπως δηλώνεται ως δαπάνη στο Έντυπο Ε3 του μισθωτή. Το μίσθωμα για τον εκμισθωτή δεν μπορεί να είναι μικρότερο από τα τεκμαρτά εισοδήματα, όπως ορίζονται στο άρθρο 40 του Ν. 4172/2013 (ΦΕΚ) και δηλώνεται στο Έντυπο Ε2 της ΑΑΔΕ. Σε περίπτωση δωρεάν παραχώρησης (χρησιδανείου), π.χ. από γονέα σε τέκνο, σύζυγο σε σύζυγο ή αμοιβαία ανταλλαγή χρήσης, η παραχώρηση γίνεται δωρεάν ως χρησιδάνειο (άρθρο 810 ΑΚ), χωρίς χρηματικό ή άλλο αντάλλαγμα, και δεν υπολογίζεται τεκμαρτό εισόδημα, εφόσον το αγροτεμάχιο χρησιμοποιείται για αγροτική δραστηριότητα (άρθρο 39 παρ. 4 Ν. 4172/2013). Αλλιώς, το τεκμαρτό εισόδημα είναι 3% της αντικειμενικής αξίας.", size: 18, font: "Arial" })],
                                alignment: AlignmentType.JUSTIFIED,
                                spacing: { after: 100 }
                            }),
                            new Paragraph({
                                children: [new TextRun({ text: "4. ΣΚΟΠΟΣ ΜΙΣΘΩΣΗΣ: Η μίσθωση συνάπτεται με σκοπό την καλλιέργεια του/των αγροτεμαχίου/ων από τον μισθωτή για την εκτέλεση γεωργικών δραστηριοτήτων, σύμφωνα με την ισχύουσα νομοθεσία. Επιπλέον, η μίσθωση παρέχει τη δυνατότητα στον μισθωτή να υποβάλει Ενιαία Αίτηση Ενίσχυσης (ΕΑΕ) μέσω του ΟΠΕΚΕΠΕ, για την ενεργοποίηση δικαιωμάτων βασικής ενίσχυσης και συναφών ενισχύσεων της Κοινής Αγροτικής Πολιτικής (ΚΑΠ) 2023-2027, σύμφωνα με τον Καν. ΕΕ 1307/2013 και τον Ν. 4684/2020. Υπεκμίσθωση του αγροτεμαχίου επιτρέπεται μόνο με προηγούμενη έγγραφη συναίνεση του εκμισθωτή, σύμφωνα με το άρθρο 624 ΑΚ.", size: 18, font: "Arial" })],
                                alignment: AlignmentType.JUSTIFIED,
                                spacing: { after: 100 }
                            }),
                            new Paragraph({
                                children: [new TextRun({ text: "5. ΥΠΟΧΡΕΩΣΕΙΣ ΜΙΣΘΩΤΗ - ΚΑΛΗ ΧΡΗΣΗ ΤΟΥ ΜΙΣΘΙΟΥ: Ο μισθωτής υποχρεούται να χρησιμοποιεί το μίσθιο με επιμέλεια, σύμφωνα με τον προορισμό του, και να το διατηρεί σε κατάσταση κατάλληλη για τη συμφωνημένη χρήση.", size: 18, font: "Arial" })],
                                alignment: AlignmentType.JUSTIFIED,
                                spacing: { after: 100 }
                            }),
                            new Paragraph({
                                children: [new TextRun({ text: "6. ΤΕΛΙΚΕΣ ΔΙΑΤΑΞΕΙΣ: Το παρόν συμφωνητικό διαβάστηκε και έγινε αμοιβαία αποδεκτό από τους συμβαλλόμενους. Κάθε συμβαλλόμενος έλαβε ένα (1) όμοιο αντίτυπο, το οποίο έχει πλήρη νομική ισχύ.", size: 18, font: "Arial" })],
                                alignment: AlignmentType.JUSTIFIED,
                                spacing: { after: 200 }
                            }),
                            new Paragraph({
                                children: [new TextRun({ text: "ΟΙ ΣΥΜΒΑΛΛΟΜΕΝΟΙ", bold: true, size: 18, font: "Arial" })],
                                alignment: AlignmentType.CENTER,
                                spacing: { before: 200, after: 100 }
                            }),
                            new Table({
                                width: { size: 100, type: WidthType.PERCENTAGE },
                                borders: { top: { style: BorderStyle.NONE, size: 0 }, bottom: { style: BorderStyle.NONE, size: 0 }, left: { style: BorderStyle.NONE, size: 0 }, right: { style: BorderStyle.NONE, size: 0 } },
                                rows: [
                                    new TableRow({
                                        children: [
                                            new TableCell({
                                                width: { size: 50, type: WidthType.PERCENTAGE },
                                                children: [new Paragraph({ children: [new TextRun({ text: `ΘΕΩΡΗΘΗΚΕ ΤΟ ΓΝΗΣΙΟ ΤΗΣ ΥΠΟΓΡΑΦΗΣ\nΕΚΜΙΣΘΩΤΗΣ ${agreement.owner.full_name}\nμε Α.Δ.Τ.: ________________`, size: 18, font: "Arial" })], alignment: AlignmentType.CENTER })]
                                            }),
                                            new TableCell({
                                                width: { size: 50, type: WidthType.PERCENTAGE },
                                                children: [new Paragraph({ children: [new TextRun({ text: `ΘΕΩΡΗΘΗΚΕ ΤΟ ΓΝΗΣΙΟ ΤΗΣ ΥΠΟΓΡΑΦΗΣ\nΜΙΣΘΩΤΗΣ ${tenant.first_name || 'Unknown'} ${tenant.last_name || 'Tenant'} ${tenant.father_name ? 'του ' + tenant.father_name : ''}\nμε Α.Δ.Τ.: ${tenant.identity_number || '-'}`, size: 18, font: "Arial" })], alignment: AlignmentType.CENTER })]
                                            })
                                        ]
                                    })
                                ]
                            }),
                             new Paragraph({
                                children: [new TextRun({ text: "                                                        ", size: 18, font: "Arial" })],
                                alignment: AlignmentType.JUSTIFIED,
                                spacing: { after: 200 }
                            }),
                            new Paragraph({
                                children: [new TextRun({ text: "                                                        ", size: 18, font: "Arial" })],
                                alignment: AlignmentType.JUSTIFIED,
                                spacing: { after: 200 }
                            }),
                            new Paragraph({
                                children: [new TextRun({ text: "                                                        ", size: 18, font: "Arial" })],
                                alignment: AlignmentType.JUSTIFIED,
                                spacing: { after: 200 }
                            }),
                            new Paragraph({
                                children: [new TextRun({ text: "                                                        ", size: 18, font: "Arial" })],
                                alignment: AlignmentType.JUSTIFIED,
                                spacing: { after: 200 }
                            }),
                            new Paragraph({
                                children: [new TextRun({ text: "Για το γνήσιο των υπογραφών", size: 18, font: "Arial" })],
                                alignment: AlignmentType.JUSTIFIED,
                                spacing: { before: 200, after: 100 }
                            }),
                            new Paragraph({
                                children: [new TextRun({ text: `ΗΜΕΡΟΜΗΝΙΑ: ${rentalStartDate}`, size: 18, font: "Arial" })],
                                alignment: AlignmentType.JUSTIFIED,
                                spacing: { after: 100 }
                            }),
                            ...(index < allAgreementsData.length - 1 ? [new Paragraph({ children: [new TextRun({ text: "", break: 1 })], pageBreakBefore: true })] : [])
                        ];
                    })
                }]
            });

            try {
                const blob = await docx.Packer.toBlob(doc);
                saveAs(blob, `All_Agreements_Single_${new Date().toISOString().slice(0, 10)}.docx`);
            } catch (error) {
                displayError('Error generating single document: ' + error.message);
            }
        }

        async function downloadAllAgreements() {
            if (!window.JSZip || agreementBlobs.length === 0) {
                displayError('Unable to download all agreements. JSZip not loaded or no agreements generated.');
                return;
            }

            const zip = new JSZip();
            agreementBlobs.forEach((item) => zip.file(item.filename, item.blob));

            try {
                const content = await zip.generateAsync({ type: 'blob' });
                saveAs(content, `All_Agreements_${new Date().toISOString().slice(0, 10)}.zip`);
                agreementBlobs = [];
                downloadAllBtn.style.display = 'none';
                downloadSingleBtn.style.display = 'none';
                agreementCounter.textContent = 'Agreements: 0';
            } catch (error) {
                displayError('Error creating ZIP file: ' + error.message);
            }
        }

        downloadAllBtn.addEventListener('click', downloadAllAgreements);
        downloadSingleBtn.addEventListener('click', generateSingleDocx);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenancy Agreement Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #agreement-list div {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-4xl mx-auto bg-white p-8 rounded shadow">
        <h1 class="text-2xl font-bold mb-4">Tenancy Agreement Generator</h1>
        
        <!-- PDF Upload -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700">Upload PDF</label>
            <input type="file" id="pdfUpload" accept=".pdf" class="mt-1 block w-full">
        </div>

        <!-- Parsed Data Display -->
        <div id="parsedData" class="mb-4 hidden">
            <h2 class="text-lg font-semibold">Parsed Data</h2>
            <div id="fieldsDisplay" class="mb-4"></div>
            <div id="tenantDisplay" class="mb-4"></div>
            <div id="agreementDisplay" class="mb-4"></div>
        </div>

        <!-- Agreement List -->
        <div id="agreement-list" class="mt-4"></div>
    </div>

    <script>
        // Initialize pdf.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        let fields = [];
        let tenant = {};
        let agreementDetails = {};

        async function processPDF() {
            const fileInput = document.getElementById('pdfUpload');
            if (!fileInput.files.length) return;

            const file = fileInput.files[0];
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let text = '';

            // Extract text from all pages
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                text += textContent.items.map(item => item.str).join(' ') + '\n';
            }

            // Parse PDF text to extract fields, owners, tenant, and agreement details
            fields = [];
            tenant = {};
            agreementDetails = {};
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            let currentField = null;

            for (let line of lines) {
                // Match field data (e.g., "1. COMMUNITY LOCATION ATAK KTM MAP AREA" or "1 1 COMMUNITY ...")
                const fieldMatch = line.match(/^(\d+)\.?\s*(\d+)?\s*(\S+)\s*(\S+)\s*(\S+)\s*(\S+)\s*(\S+)\s*([\d.]+)/) || 
                                  line.match(/^(\d+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+([\d.]+)/);
                if (fieldMatch) {
                    if (currentField) fields.push(currentField);
                    currentField = {
                        community: fieldMatch[2] || fieldMatch[3],
                        location: fieldMatch[3] || fieldMatch[4],
                        atak: fieldMatch[4] || fieldMatch[5],
                        ktm: fieldMatch[5] || fieldMatch[6],
                        map: fieldMatch[6] || fieldMatch[7],
                        area: parseFloat(fieldMatch[7] || fieldMatch[8]) || 0,
                        owners: []
                    };
                }
                // Match owner data (e.g., "Owner NAME του FATHER, κάτοικος ADDRESS, Α.Φ.Μ TIN, Δ.Ο.Υ DOY" or variations)
                const ownerMatch = line.match(/Owner\s+(.+?)\s+του\s+(.+?)(?:,\s+κάτοικος\s+(.+?)(?:,\s+Α\.Φ\.Μ\s+(\S+)(?:,\s+Δ\.Ο\.Υ\s+(.+))?)?)?/) ||
                                  line.match(/Owner\s+(.+?)\s+(.+?)(?:,\s+(.+?)(?:,\s+(\S+)(?:,\s+(.+))?)?)?/);
                if (ownerMatch && currentField) {
                    currentField.owners.push({
                        name: ownerMatch[1] || '',
                        father: ownerMatch[2] || '',
                        address: ownerMatch[3] || '',
                        tin: ownerMatch[4] || '',
                        doy: ownerMatch[5] || ''
                    });
                }
                // Match tenant data (e.g., "Tenant NAME του FATHER, επαγγέλματος αγρότης, κάτοικος ADDRESS, Α.Φ.Μ TIN, Δ.Ο.Υ DOY")
                const tenantMatch = line.match(/Tenant\s+(.+?)\s+του\s+(.+?)(?:,\s+επαγγέλματος\s+αγρότης,\s+κάτοικος\s+(.+?)(?:,\s+Α\.Φ\.Μ\s+(\S+)(?:,\s+Δ\.Ο\.Υ\s+(.+))?)?)?/);
                if (tenantMatch) {
                    tenant = {
                        name: tenantMatch[1] || '',
                        father: tenantMatch[2] || '',
                        address: tenantMatch[3] || '',
                        tin: tenantMatch[4] || '',
                        doy: tenantMatch[5] || ''
                    };
                }
                // Match agreement details (e.g., "Start Date: DD/MM/YYYY End Date: DD/MM/YYYY Rent: AMOUNT/Ha")
                const agreementMatch = line.match(/Start\s*Date:\s*(\d{2}\/\d{2}\/\d{4})\s*End\s*Date:\s*(\d{2}\/\d{2}\/\d{4})\s*Rent:\s*([\d.]+)\/Ha/) ||
                                      line.match(/(\d{2}\/\d{2}\/\d{4})\s+to\s+(\d{2}\/\d{2}\/\d{4})\s+([\d.]+)\/Ha/);
                if (agreementMatch) {
                    agreementDetails = {
                        startDate: agreementMatch[1] || '',
                        endDate: agreementMatch[2] || '',
                        rentAmount: parseFloat(agreementMatch[3]) || 0
                    };
                }
            }
            if (currentField) fields.push(currentField);

            // Fallback defaults if tenant or agreement details are not found
            if (!tenant.name) {
                tenant = {
                    name: 'Unknown Tenant',
                    father: 'Unknown',
                    address: 'Unknown Address',
                    tin: 'Unknown TIN',
                    doy: 'Unknown DOY'
                };
            }
            if (!agreementDetails.startDate) {
                const today = new Date();
                const nextYear = new Date(today.getFullYear() + 1, 11, 31);
                agreementDetails = {
                    startDate: today.toLocaleDateString('en-GB'),
                    endDate: nextYear.toLocaleDateString('en-GB'),
                    rentAmount: 100
                };
            }

            // Display parsed data
            const parsedDataDiv = document.getElementById('parsedData');
            const fieldsDisplay = document.getElementById('fieldsDisplay');
            const tenantDisplay = document.getElementById('tenantDisplay');
            const agreementDisplay = document.getElementById('agreementDisplay');
            parsedDataDiv.classList.remove('hidden');
            fieldsDisplay.innerHTML = '';
            tenantDisplay.innerHTML = '';
            agreementDisplay.innerHTML = '';

            // Display fields and owners
            if (fields.length > 0) {
                fields.forEach((field, i) => {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'mb-4 p-4 border rounded';
                    fieldDiv.innerHTML = `
                        <h3 class="font-semibold">Field ${i + 1}</h3>
                        <p>Community: ${field.community}</p>
                        <p>Location: ${field.location}</p>
                        <p>ATAK: ${field.atak}</p>
                        <p>KTM: ${field.ktm}</p>
                        <p>Cartographic Code: ${field.map}</p>
                        <p>Area: ${field.area} Ha</p>
                        <h4 class="font-medium mt-2">Owners:</h4>
                        ${field.owners.map((owner, j) => `
                            <div class="ml-4">
                                <p>Owner ${j + 1}: ${owner.name}</p>
                                <p>Father: ${owner.father}</p>
                                <p>Address: ${owner.address}</p>
                                <p>TIN: ${owner.tin}</p>
                                <p>DOY: ${owner.doy}</p>
                            </div>
                        `).join('')}
                    `;
                    fieldsDisplay.appendChild(fieldDiv);
                });
            } else {
                fieldsDisplay.innerHTML = '<p>No fields detected in the PDF.</p>';
            }

            // Display tenant info
            tenantDisplay.innerHTML = `
                <h3 class="font-semibold">Tenant Information</h3>
                <p>Name: ${tenant.name}</p>
                <p>Father: ${tenant.father}</p>
                <p>Address: ${tenant.address}</p>
                <p>TIN: ${tenant.tin}</p>
                <p>DOY: ${tenant.doy}</p>
            `;

            // Display agreement details
            agreementDisplay.innerHTML = `
                <h3 class="font-semibold">Agreement Details</h3>
                <p>Start Date: ${agreementDetails.startDate}</p>
                <p>End Date: ${agreementDetails.endDate}</p>
                <p>Rent Amount: ${agreementDetails.rentAmount} €/Ha</p>
            `;

            // Generate agreements automatically
            generateAgreements();
        }

        function generateAgreements() {
            if (!fields.length) {
                alert('No fields data available. Please upload a PDF with valid field data.');
                return;
            }

            // Merge agreements by TIN
            const agreementsByTIN = {};
            fields.forEach((field, index) => {
                field.owners.forEach(owner => {
                    const ownerTin = owner.tin || 'Unknown TIN';
                    if (!agreementsByTIN[ownerTin]) {
                        agreementsByTIN[ownerTin] = {
                            owner: owner,
                            fields: []
                        };
                    }
                    agreementsByTIN[ownerTin].fields.push({ ...field, index: index + 1 });
                });
            });

            // Generate agreements
            const agreementList = document.getElementById('agreement-list');
            agreementList.innerHTML = '';

            Object.keys(agreementsByTIN).forEach(tin => {
                const agreement = agreementsByTIN[tin];
                const doc = new jspdf.jsPDF();
                doc.setFontSize(12);

                // Generating agreement content
                doc.text('ΙΔΙΩΤΙΚΟ ΣΥΜΦΩΝΗΤΙΚΟ ΑΓΡΟΜΙΣΘΩΣΗΣ', 20, 20);
                doc.text(`Σήμερα την ${agreementDetails.startDate} στο Δημητρίτσι οι υπογράφοντες το συμφωνητικό αυτό`, 20, 30);
                doc.text(`αφενός ο/η ${agreement.owner.name || 'Unknown Owner'} του ${agreement.owner.father || 'Unknown'}, κάτοικος ${agreement.owner.address || 'Unknown Address'},`, 20, 40);
                doc.text(`Α.Φ.Μ ${agreement.owner.tin || 'Unknown TIN'}, Δ.Ο.Υ ${agreement.owner.doy || 'Unknown DOY'}`, 20, 50);
                doc.text(`και αφετέρου ο/η ${tenant.name} του ${tenant.father}, επαγγέλματος αγρότης,`, 20, 60);
                doc.text(`κάτοικος ${tenant.address}, Α.Φ.Μ ${tenant.tin}, Δ.Ο.Υ ${tenant.doy}`, 20, 70);
                doc.text('συμφώνησαν από κοινού και αποδέχτηκαν τα εξής:', 20, 80);

                doc.text('1. ΜΙΣΘΙΟ. Ο πρώτος συμβαλλόμενος ("εκμισθωτής") έχει στην αποκλειστική κυριότητα, νομή και κατοχή του τους κάτωθι αγρούς:', 20, 90);
                let y = 100;
                doc.text('Α/Α  ΚΟΙΝΟΤΗΤΑ  ΤΟΠΟΘΕΣΙΑ  Α.Τ.Α.Κ.  ΑΡ.ΚΤΗΜ.ΤΕΜ.  ΧΑΡΤΟΓΡΑΦΙΚΟ  ΕΚΤΑΣΗ (Ha)', 20, y);
                y += 10;

                agreement.fields.forEach(field => {
                    doc.text(`${field.index}. ${field.community}  ${field.location}  ${field.atak}  ${field.ktm}  ${field.map}  ${field.area}`, 20, y);
                    y += 10;
                });

                y += 10;
                doc.text('Ο εκμισθωτής εκμισθώνει με το παρόν συμφωνητικό στο μισθωτή τους παραπάνω αγρούς, με τους εξής όρους και συμφωνίες που είναι όλοι ουσιώδεις:', 20, y);
                y += 10;
                doc.text(`2. ΔΙΑΡΚΕΙΑ. Η διάρκεια της παρούσας μίσθωσης ορίζεται: Αρχίζει την ${agreementDetails.startDate} και λήγει την ${agreementDetails.endDate}.`, 20, y);
                y += 10;
                doc.text(`3. ΜΙΣΘΩΜΑ. Το ετήσιο μίσθωμα ορίζεται σε ευρώ ${agreementDetails.rentAmount}/Ha`, 20, y);
                y += 10;
                doc.text('4. ΧΡΗΣΗ. Ο μίσθιος αγρός θα χρησιμοποιηθεί αποκλειστικά για αγροτική καλλιέργεια. Απαγορεύεται απόλυτα οποιαδήποτε μετατροπή της χρήσης ή του τρόπου εκμετάλλευσης του μισθίου, η ολική ή μερική υπομίσθωσή του, ή η με οποιοδήποτε τρόπο, με ή χωρίς αντάλλαγμα παραχώρηση της χρήσης του μισθίου σε τρίτους καθώς και η πρόσληψη συνεταίρου, χωρίς την προηγούμενη έγγραφη συναίνεση του εκμισθωτή.', 20, y, { maxWidth: 170 });
                y += 40;
                doc.text('5. ΚΑΛΗ ΧΡΗΣΗ ΤΟΥ ΜΙΣΘΙΟΥ. Ο μισθωτής υποχρεούται να κάνει καλή χρήση του μισθίου, να το εκμεταλλεύεται με επιμέλεια και σύμφωνα με τον προορισμό του και να το διατηρεί κατάλληλο για τη συμφωνημένη χρήση, κάνοντας με αποκλειστική δαπάνη και επιμέλειά του κάθε είδους τακτικές ή έκτακτες επισκευές ή βελτιώσεις, διαφορετικά, ευθύνεται για αποζημίωση για τις φθορές και τις βλάβες που προξενήθηκαν σ\' αυτό.', 20, y, { maxWidth: 170 });
                y += 40;
                doc.text('Το παρόν μισθωτήριο διαβάστηκε και έγινε αποδεκτό από τους συμβαλλομένους, υπογράφη από αυτούς και ο καθένας έλαβε από ένα όμοιο αντίτυπο.', 20, y, { maxWidth: 170 });
                y += 20;
                doc.text('ΟΙ ΣΥΜΒΑΛΛΟΜΕΝΟΙ', 20, y);
                y += 10;
                doc.text('Ο ΕΚΜΙΣΘΩΤΗΣ _________________ ΘΕΩΡΗΘΗΚΕ _________________ Ο ΜΙΣΘΩΤΗΣ', 20, y);
                y += 10;
                doc.text('Για το γνήσιο των υπογραφών', 20, y);
                y += 10;
                doc.text('ΗΜΕΡΟΜΗΝΙΑ _________________', 20, y);

                const agreementDiv = document.createElement('div');
                agreementDiv.innerHTML = `
                    <p>Agreement for ${agreement.owner.name || 'Unknown Owner'} (TIN: ${tin})</p>
                    <button class="bg-blue-500 text-white p-2 rounded" onclick="downloadPDF('${tin}')">Download PDF</button>
                `;
                agreementList.appendChild(agreementDiv);

                // Store PDF for download
                window['pdf_' + tin] = doc;
            });
        }

        function downloadPDF(tin) {
            const doc = window['pdf_' + tin];
            doc.save(`agreement_${tin}.pdf`);
        }

        // Handle PDF upload
        document.getElementById('pdfUpload').addEventListener('change', processPDF);
    </script>
</body>
</html>

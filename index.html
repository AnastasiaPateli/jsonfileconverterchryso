<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Tools - Tenancy Agreement Generator & PDF Combiner</title>
    <!-- Load libraries with fallback CDN -->
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script>
        // Fallback for docx.js
        if (!window.docx) {
            document.write('<script src="https://cdn.jsdelivr.net/npm/docx@7.8.2/build/index.min.js"><\/script>');
        }
        // Fallback for FileSaver.js
        if (!window.saveAs) {
            document.write('<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"><\/script>');
        }
        // Fallback for JSZip
        if (!window.JSZip) {
            document.write('<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/jszip.min.js"><\/script>');
        }
        // Fallback for PDF-lib
        if (!window.PDFLib) {
            document.write('<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"><\/script>');
        }
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: white;
            text-align: center;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .main-container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            gap: 20px;
            padding: 0 20px;
            min-height: calc(100vh - 120px);
        }
        
        .left-panel, .right-panel {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow-y: auto;
            max-height: calc(100vh - 140px);
        }
        
        .panel-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }
        
        .panel-header h2 {
            color: #333;
            margin: 0;
            font-size: 1.5em;
        }
        
        /* Left Panel Styles (existing) */
        .upload-section, .agreements-section {
            margin-bottom: 20px;
        }
        
        button, input[type="file"] {
            padding: 10px;
            margin: 10px 0;
            cursor: pointer;
            border-radius: 8px;
            border: 2px solid #667eea;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        button:hover, input[type="file"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .agreement {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .download-btn, .download-all-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 8px 16px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .download-btn:hover, .download-all-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        
        .error {
            color: #e74c3c;
            margin: 10px 0;
            padding: 10px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
        }
        
        .download-all-section {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .agreement-counter {
            margin-left: 10px;
            font-size: 14px;
            color: #666;
        }
        
        /* Right Panel Styles (PDF Combiner) */
        .pdf-drop-zone {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .pdf-drop-zone:hover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.05);
        }
        
        .pdf-drop-zone.dragover {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
            transform: scale(1.02);
        }
        
        .pdf-files-list {
            margin-bottom: 20px;
        }
        
        .pdf-file-item {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: 10px 15px;
            margin: 5px 0;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .pdf-file-info {
            flex-grow: 1;
        }
        
        .pdf-file-name {
            font-weight: bold;
            color: #333;
        }
        
        .pdf-file-size {
            font-size: 12px;
            color: #666;
        }
        
        .remove-pdf-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin-left: 10px;
        }
        
        .remove-pdf-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }
        
        .combine-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            margin-top: 15px;
        }
        
        .combine-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .combine-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
            display: none;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        table th, table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        
        table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
        }
        
        table tr:nth-child(even) {
            background-color: rgba(102, 126, 234, 0.05);
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                padding: 0 10px;
            }
            
            .left-panel, .right-panel {
                max-height: none;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Document Processing Tools</h1>
    </div>
    
    <div class="main-container">
        <!-- Left Panel - Tenancy Agreement Generator -->
        <div class="left-panel">
            <div class="panel-header">
                <h2>üè† Tenancy Agreement Generator</h2>
            </div>
            
            <div class="download-all-section">
                <button class="download-all-btn" id="downloadAllBtn" style="display: none;">Download All Agreements</button>
                <span class="agreement-counter" id="agreementCounter">Agreements: 0</span>
            </div>
            
            <div class="upload-section">
                <input type="file" id="jsonFile" accept=".json" placeholder="Select JSON file">
                <div id="error" class="error" style="display: none;"></div>
            </div>
            
            <div class="agreements-section" id="agreements"></div>
        </div>
        
        <!-- Right Panel - PDF Combiner -->
        <div class="right-panel">
            <div class="panel-header">
                <h2>üìÑ PDF Combiner</h2>
            </div>
            
            <div class="pdf-drop-zone" id="pdfDropZone">
                <div style="font-size: 48px; margin-bottom: 15px;">üìÅ</div>
                <p><strong>Drop PDF files here or click to browse</strong></p>
                <p style="color: #666; font-size: 14px;">Select multiple PDF files to combine into one document</p>
                <input type="file" id="pdfFiles" accept=".pdf" multiple style="display: none;">
            </div>
            
            <div class="pdf-files-list" id="pdfFilesList"></div>
            
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <button class="combine-btn" id="combineBtn" disabled>Combine PDFs</button>
            
            <div id="pdfError" class="error" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Left Panel - Tenancy Agreement Generator (existing code)
        const jsonFileInput = document.getElementById('jsonFile');
        const agreementsDiv = document.getElementById('agreements');
        const errorDiv = document.getElementById('error');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const agreementCounter = document.getElementById('agreementCounter');
        let agreementBlobs = [];

        // Right Panel - PDF Combiner
        const pdfDropZone = document.getElementById('pdfDropZone');
        const pdfFileInput = document.getElementById('pdfFiles');
        const pdfFilesList = document.getElementById('pdfFilesList');
        const combineBtn = document.getElementById('combineBtn');
        const pdfErrorDiv = document.getElementById('pdfError');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        let selectedPDFs = [];

        // Check if required libraries are loaded
        window.addEventListener('load', () => {
            if (!window.docx || !window.saveAs || !window.JSZip) {
                showError('Required libraries (docx.js, FileSaver.js, or JSZip) failed to load. Please try again later.');
                console.error('Library Load Failure:', { docx: !!window.docx, saveAs: !!window.saveAs, JSZip: !!window.JSZip });
            }
            if (!window.PDFLib) {
                showPdfError('PDF-lib failed to load. PDF combining functionality is not available.');
                console.error('PDF-lib Load Failure');
            }
        });

        // Left Panel Event Listeners
        jsonFileInput.addEventListener('change', handleFileUpload);
        downloadAllBtn.addEventListener('click', downloadAllAgreements);

        // Right Panel Event Listeners
        pdfDropZone.addEventListener('click', () => pdfFileInput.click());
        pdfFileInput.addEventListener('change', handlePdfSelection);
        combineBtn.addEventListener('click', combinePDFs);

        // Drag and drop functionality
        pdfDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            pdfDropZone.classList.add('dragover');
        });

        pdfDropZone.addEventListener('dragleave', () => {
            pdfDropZone.classList.remove('dragover');
        });

        pdfDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            pdfDropZone.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type === 'application/pdf');
            if (files.length > 0) {
                addPDFFiles(files);
            }
        });

        // Helper functions
        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            errorDiv.style.display = 'none';
        }

        function showPdfError(message) {
            pdfErrorDiv.textContent = message;
            pdfErrorDiv.style.display = 'block';
        }

        function hidePdfError() {
            pdfErrorDiv.style.display = 'none';
        }

        // Left Panel Functions (existing code with modifications)
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                showError('No file selected.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    const tenantTin = data.tin || '';
                    if (!tenantTin) {
                        showError('No TIN found in JSON data.');
                        return;
                    }
                    console.log('Tenant TIN:', tenantTin);
                    generateAgreements(data, tenantTin);
                    hideError();
                } catch (error) {
                    showError('Error parsing JSON file: ' + error.message);
                    console.error('JSON Parse Error:', error);
                }
            };
            reader.onerror = function() {
                showError('Error reading file.');
                console.error('FileReader Error:', reader.error);
            };
            reader.readAsText(file);
        }

        function generateAgreements(data, tenantTin) {
            agreementsDiv.innerHTML = '';
            agreementBlobs = [];
            const tenant = data.applicant_detail || {};
            const fields = Array.isArray(data.field_list) ? data.field_list : [];

            if (!fields.length) {
                showError('No fields found in the JSON data.');
                return;
            }

            const agreementsByTinAndDates = {};

            fields.forEach(field => {
                const fieldInfo = field.field_info || {};
                const propertyList = Array.isArray(field.field_property_list) ? field.field_property_list : [];
                const geospatialData = field.field_geospatial_data || {};

                propertyList.forEach(property => {
                    const tin = property.tin || 'unknown_tin_' + Math.random().toString(36).substr(2, 9);
                    const fullName = property.full_name || 'Unknown Owner';
                    
                    if (tin.startsWith('unknown_tin_') || fullName === 'Unknown Owner') {
                        console.log(`Skipping field due to unknown owner: TIN=${tin}, Name=${fullName}`);
                        return;
                    }
                    
                    if (tin === tenantTin) {
                        console.log(`Skipping field for TIN ${tin} as it matches tenant TIN ${tenantTin}`);
                        return;
                    }
                    
                    const rentalKey = `${tin}_${property.rental_start_date || '-'}_${property.rental_end_date || '-'}`;
                    if (!agreementsByTinAndDates[rentalKey]) {
                        agreementsByTinAndDates[rentalKey] = {
                            owner: {
                                tin: property.tin || 'Unknown',
                                full_name: fullName,
                                doy: 'Œë Œ£ŒµœÅœÅœéŒΩ'
                            },
                            rental_start_date: property.rental_start_date || '-',
                            rental_end_date: property.rental_end_date || '-',
                            fields: []
                        };
                    }
                    agreementsByTinAndDates[rentalKey].fields.push({
                        serial_number: geospatialData.serial_number || '-',
                        community: geospatialData.community_code || 'Unknown',
                        location: fieldInfo.location || 'Unknown',
                        atak: property.atak || '-',
                        other_cartographic_background: fieldInfo.other_cartographic_background || '-',
                        cartographic_background: geospatialData.cartographic_background || '-',
                        area_ha: property.area_participation_atak || '0',
                        rental_start_date: property.rental_start_date || '-',
                        rental_end_date: property.rental_end_date || '-',
                        property_tin: property.tin
                    });
                });
            });

            if (Object.keys(agreementsByTinAndDates).length === 0) {
                showError('No valid agreements generated. All fields may belong to the tenant or have invalid data.');
                downloadAllBtn.style.display = 'none';
                agreementCounter.textContent = 'Agreements: 0';
                return;
            }

            const agreementCount = Object.keys(agreementsByTinAndDates).length;
            agreementCounter.textContent = `Agreements: ${agreementCount}`;
            downloadAllBtn.style.display = agreementCount > 1 ? 'block' : 'none';

            Object.values(agreementsByTinAndDates).forEach((agreement, index) => {
                const agreementDiv = document.createElement('div');
                agreementDiv.className = 'agreement';
                
                const title = document.createElement('h3');
                title.textContent = `Agreement ${index + 1} for ${agreement.owner.full_name} (TIN: ${agreement.owner.tin}, ${agreement.rental_start_date} - ${agreement.rental_end_date})`;
                agreementDiv.appendChild(title);

                const table = document.createElement('table');
                table.innerHTML = `
                    <tr>
                        <th>Œë/Œë</th>
                        <th>ŒöŒüŒôŒùŒüŒ§ŒóŒ§Œë (Œ∫œâŒ¥.)</th>
                        <th>Œ§ŒüŒ†ŒüŒòŒïŒ£ŒôŒë</th>
                        <th>Œë.Œ§.Œë.Œö.</th>
                        <th>ŒëŒ°.ŒöŒ§ŒóŒú.Œ§ŒïŒú.</th>
                        <th>ŒßŒëŒ°Œ§ŒüŒìŒ°ŒëŒ¶ŒôŒöŒü</th>
                        <th>ŒïŒöŒ§ŒëŒ£Œó (Ha)</th>
                    </tr>
                `;
                agreement.fields.forEach((field, fieldIndex) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${fieldIndex + 1}</td>
                        <td>${field.community}</td>
                        <td>${field.location}</td>
                        <td>${field.atak}</td>
                        <td>${field.other_cartographic_background}</td>
                        <td>${field.cartographic_background}</td>
                        <td>${field.area_ha}</td>
                    `;
                    table.appendChild(row);
                });
                agreementDiv.appendChild(table);

                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'download-btn';
                downloadBtn.textContent = 'Download Agreement';
                downloadBtn.onclick = () => {
                    try {
                        generateDocx(agreement, tenant, tenantTin, false);
                    } catch (error) {
                        showError('Error generating document: ' + error.message);
                        console.error('Document Generation Error:', error);
                    }
                };
                agreementDiv.appendChild(downloadBtn);

                try {
                    generateDocx(agreement, tenant, tenantTin, true);
                } catch (error) {
                    console.error('Error generating blob for agreement:', error);
                    showError('Error preparing agreement for download all: ' + error.message);
                }

                agreementsDiv.appendChild(agreementDiv);
            });
        }

        function generateDocx(agreement, tenant, tenantTin, storeBlob = false) {
            if (!window.docx || !window.saveAs) {
                throw new Error('Required libraries (docx.js or FileSaver.js) are not loaded.');
            }

            const { Document, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, AlignmentType, BorderStyle } = docx;

            const rentalStartDate = agreement.rental_start_date !== '-' ? 
                new Date(agreement.rental_start_date).toLocaleDateString('el-GR', { day: 'numeric', month: 'long', year: 'numeric' }) : '-';
            const rentalEndDate = agreement.rental_end_date !== '-' ? 
                new Date(agreement.rental_end_date).toLocaleDateString('el-GR', { day: 'numeric', month: 'long', year: 'numeric' }) : '-';

            const doc = new Document({
                sections: [{
                    children: [
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "ŒôŒîŒôŒ©Œ§ŒôŒöŒü Œ£Œ•ŒúŒ¶Œ©ŒùŒóŒ§ŒôŒöŒü ŒëŒìŒ°ŒüŒúŒôŒ£ŒòŒ©Œ£ŒóŒ£",
                                    bold: true,
                                    size: 28,
                                    font: "Arial"
                                })
                            ],
                            alignment: AlignmentType.JUSTIFIED
                        }),
                        new Paragraph({ 
                            children: [new TextRun({ text: "", size: 24 })],
                            alignment: AlignmentType.JUSTIFIED 
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "Œ£ŒÆŒºŒµœÅŒ± œÑŒ∑ŒΩ 1Œ∑ ŒùŒøŒµŒºŒ≤œÅŒØŒøœÖ 2024 œÉœÑŒø ŒîŒ∑ŒºŒ∑œÑœÅŒØœÑœÉŒπ ŒøŒπ œÖœÄŒøŒ≥œÅŒ¨œÜŒøŒΩœÑŒµœÇ œÑŒø œÉœÖŒºœÜœâŒΩŒ∑œÑŒπŒ∫œå Œ±œÖœÑœå",
                                    size: 22,
                                    font: "Arial"
                                })
                            ],
                            alignment: AlignmentType.JUSTIFIED
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: `Œ±œÜŒµŒΩœåœÇ Œø/Œ∑ ${agreement.owner.full_name}, Œ∫Œ¨œÑŒøŒπŒ∫ŒøœÇ -, ŒøŒ¥œåœÇ -, Œ±œÅ. -, Œë.Œ¶.Œú ${agreement.owner.tin}, Œî.Œü.Œ• ${agreement.owner.doy}`,
                                    size: 22,
                                    font: "Arial"
                                })
                            ],
                            alignment: AlignmentType.JUSTIFIED
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: `Œ∫Œ±Œπ Œ±œÜŒµœÑŒ≠œÅŒøœÖ Œø/Œ∑ ${tenant.first_name || 'Unknown'} ${tenant.last_name || 'Tenant'} ${tenant.father_name ? 'œÑŒøœÖ ' + tenant.father_name : ''}, ŒµœÄŒ±Œ≥Œ≥Œ≠ŒªŒºŒ±œÑŒøœÇ Œ±Œ≥œÅœåœÑŒ∑œÇ, Œ∫Œ¨œÑŒøŒπŒ∫ŒøœÇ 62200, ŒøŒ¥œåœÇ -, Œ±œÅ. -, Œë.Œ¶.Œú ${tenantTin}, Œî.Œü.Œ• Œë Œ£ŒµœÅœÅœéŒΩ`,
                                    size: 22,
                                    font: "Arial"
                                })
                            ],
                            alignment: AlignmentType.JUSTIFIED
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "œÉœÖŒºœÜœéŒΩŒ∑œÉŒ±ŒΩ Œ±œÄœå Œ∫ŒøŒπŒΩŒøœç Œ∫Œ±Œπ Œ±œÄŒøŒ¥Œ≠œáœÑŒ∑Œ∫Œ±ŒΩ œÑŒ± ŒµŒæŒÆœÇ:",
                                    size: 22,
                                    font: "Arial"
                                })
                            ],
                            alignment: AlignmentType.JUSTIFIED
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "1. ŒúŒôŒ£ŒòŒôŒü. Œü œÄœÅœéœÑŒøœÇ œÉœÖŒºŒ≤Œ±ŒªŒªœåŒºŒµŒΩŒøœÇ (\"ŒµŒ∫ŒºŒπœÉŒ∏œâœÑŒÆ\") Œ≠œáŒµŒπ œÉœÑŒ∑ŒΩ Œ±œÄŒøŒ∫ŒªŒµŒπœÉœÑŒπŒ∫ŒÆ Œ∫œÖœÅŒπœåœÑŒ∑œÑŒ±, ŒΩŒøŒºŒÆ Œ∫Œ±Œπ Œ∫Œ±œÑŒøœáŒÆ œÑŒøœÖ œÑŒøœÖœÇ Œ∫Œ¨œÑœâŒ∏Œπ Œ±Œ≥œÅŒøœçœÇ:",
                                    size: 22,
                                    font: "Arial"
                                })
                            ],
                            alignment: AlignmentType.JUSTIFIED
                        }),
                        new Table({
                            width: { size: 100, type: WidthType.PERCENTAGE },
                            rows: [
                                new TableRow({
                                    children: [
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "Œë/Œë", font: "Arial" })], alignment: AlignmentType.CENTER })], width: { size: 5, type: WidthType.PERCENTAGE } }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "ŒöŒüŒôŒùŒüŒ§ŒóŒ§Œë", font: "Arial" })], alignment: AlignmentType.CENTER })], width: { size: 15, type: WidthType.PERCENTAGE } }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "Œ§ŒüŒ†ŒüŒòŒïŒ£ŒôŒë", font: "Arial" })], alignment: AlignmentType.CENTER })], width: { size: 20, type: WidthType.PERCENTAGE } }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "Œë.Œ§.Œë.Œö.", font: "Arial" })], alignment: AlignmentType.CENTER })], width: { size: 20, type: WidthType.PERCENTAGE } }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "ŒëŒ°.ŒöŒ§ŒóŒú.Œ§ŒïŒú.", font: "Arial" })], alignment: AlignmentType.CENTER })], width: { size: 15, type: WidthType.PERCENTAGE } }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "ŒßŒëŒ°Œ§ŒüŒìŒ°ŒëŒ¶ŒôŒöŒü", font: "Arial" })], alignment: AlignmentType.CENTER })], width: { size: 15, type: WidthType.PERCENTAGE } }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "ŒïŒöŒ§ŒëŒ£Œó (Ha)", font: "Arial" })], alignment: AlignmentType.CENTER })], width: { size: 10, type: WidthType.PERCENTAGE } })
                                    ]
                                }),
                                ...agreement.fields.map((field, index) => new TableRow({
                                    children: [
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: (index + 1).toString(), font: "Arial" })], alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: field.community, font: "Arial" })], alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: field.location, font: "Arial" })], alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: field.atak, font: "Arial" })], alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: field.other_cartographic_background, font: "Arial" })], alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: field.cartographic_background, font: "Arial" })], alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: field.area_ha.toString(), font: "Arial" })], alignment: AlignmentType.CENTER })] })
                                    ]
                                }))
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: `2. ŒßŒ°ŒüŒùŒüŒ£ ŒúŒôŒ£ŒòŒ©Œ£ŒóŒ£. Œó Œ¥ŒπŒ¨œÅŒ∫ŒµŒπŒ± œÑŒ∑œÇ ŒºŒØœÉŒ∏œâœÉŒ∑œÇ ŒøœÅŒØŒ∂ŒµœÑŒ±Œπ Œ±œÄœå ${rentalStartDate} ŒºŒ≠œáœÅŒπ ${rentalEndDate}.`,
                                    size: 22,
                                    font: "Arial"
                                })
                            ],
                            alignment: AlignmentType.JUSTIFIED
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "3. ŒúŒôŒ£ŒòŒ©ŒúŒë. Œ§Œø ŒºŒØœÉŒ∏œâŒºŒ± ŒøœÅŒØŒ∂ŒµœÑŒ±Œπ œÉŒµ 0 ŒµœÖœÅœé, Œ∫Œ±Œ∏œåœÉŒøŒΩ œÄœÅœåŒ∫ŒµŒπœÑŒ±Œπ Œ≥ŒπŒ± Œ¥œâœÅŒµŒ¨ŒΩ œÄŒ±œÅŒ±œáœéœÅŒ∑œÉŒ∑ œáœÅŒÆœÉŒ∑œÇ, œåœÄœâœÇ œÄœÅŒøŒ≤ŒªŒ≠œÄŒµœÑŒ±Œπ Œ±œÄœå œÑŒø Œ¨œÅŒ∏œÅŒø 10 œÄŒ±œÅ. 3 œÑŒøœÖ Œù. 4067/2012.",
                                    size: 22,
                                    font: "Arial"
                                })
                            ],
                            alignment: AlignmentType.JUSTIFIED
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "4. Œ£ŒöŒüŒ†ŒüŒ£ ŒúŒôŒ£ŒòŒ©Œ£ŒóŒ£. Œó ŒµŒ∫ŒºŒØœÉŒ∏œâœÉŒ∑ Œ≥ŒØŒΩŒµœÑŒ±Œπ Œ≥ŒπŒ± œÑŒ∑ŒΩ Œ∫Œ±ŒªŒªŒπŒ≠œÅŒ≥ŒµŒπŒ± œÑœâŒΩ œÄŒ±œÅŒ±œÄŒ¨ŒΩœâ Œ±Œ≥œÅœéŒΩ, Œ±œÄŒøŒ∫ŒªŒµŒπœÉœÑŒπŒ∫Œ¨ Œ±œÄœå œÑŒø ŒºŒπœÉŒ∏œâœÑŒÆ, ŒºŒµ œÉŒ∫ŒøœÄœå œÑŒ∑ŒΩ ŒµŒ∫œÑŒ≠ŒªŒµœÉŒ∑ œÑœâŒΩ Œ≥ŒµœâœÅŒ≥ŒπŒ∫œéŒΩ œÑŒøœÖ Œ¥œÅŒ±œÉœÑŒ∑œÅŒπŒøœÑŒÆœÑœâŒΩ, œåœÄœâœÇ œÄœÅŒøŒ≤ŒªŒ≠œÄŒøŒΩœÑŒ±Œπ Œ±œÄœå œÑŒ∑ŒΩ Œ∫ŒµŒØŒºŒµŒΩŒ∑ ŒΩŒøŒºŒøŒ∏ŒµœÉŒØŒ±.",
                                    size: 22,
                                    font: "Arial"
                                })
                            ],
                            alignment: AlignmentType.JUSTIFIED
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "5. ŒöŒëŒõŒó ŒßŒ°ŒóŒ£Œó Œ§ŒüŒ• ŒúŒôŒ£ŒòŒôŒüŒ•. Œü ŒºŒπœÉŒ∏œâœÑŒÆ œÖœÄŒøœáœÅŒµŒøœçœÑŒ±Œπ ŒΩŒ± Œ∫Œ¨ŒΩŒµŒπ Œ∫Œ±ŒªŒÆ œáœÅŒÆœÉŒ∑ œÑŒøœÖ ŒºŒπœÉŒ∏ŒØŒøœÖ, ŒΩŒ± œÑŒø ŒµŒ∫ŒºŒµœÑŒ±ŒªŒªŒµœçŒµœÑŒ±Œπ ŒºŒµ ŒµœÄŒπŒºŒ≠ŒªŒµŒπŒ± Œ∫Œ±Œπ œÉœçŒºœÜœâŒΩŒ± ŒºŒµ œÑŒøŒΩ œÄœÅŒøŒøœÅŒπœÉŒºœå œÑŒøœÖ Œ∫Œ±Œπ ŒΩŒ± œÑŒø Œ¥ŒπŒ±œÑŒ∑œÅŒµŒØ Œ∫Œ±œÑŒ¨ŒªŒªŒ∑ŒªŒø Œ≥ŒπŒ± œÑŒ∑ œÉœÖŒºœÜœâŒΩŒ∑ŒºŒ≠ŒΩŒ∑ œáœÅŒÆœÉŒ∑, Œ∫Œ¨ŒΩŒøŒΩœÑŒ±œÇ ŒºŒµ Œ±œÄŒøŒ∫ŒªŒµŒπœÉœÑŒπŒ∫ŒÆ Œ¥Œ±œÄŒ¨ŒΩŒ∑ Œ∫Œ±Œπ ŒµœÄŒπŒºŒ≠ŒªŒµŒπŒ¨ œÑŒøœÖ Œ∫Œ¨Œ∏Œµ ŒµŒØŒ¥ŒøœÖœÇ œÑŒ±Œ∫œÑŒπŒ∫Œ≠œÇ ŒÆ Œ≠Œ∫œÑŒ±Œ∫œÑŒµœÇ ŒµœÄŒπœÉŒ∫ŒµœÖŒ≠œÇ ŒÆ Œ≤ŒµŒªœÑŒπœéœÉŒµŒπœÇ, Œ¥ŒπŒ±œÜŒøœÅŒµœÑŒπŒ∫Œ¨, ŒµœÖŒ∏œçŒΩŒµœÑŒ±Œπ Œ≥ŒπŒ± Œ±œÄŒøŒ∂Œ∑ŒºŒØœâœÉŒ∑ Œ≥ŒπŒ± œÑŒπœÇ œÜŒ∏ŒøœÅŒ≠œÇ Œ∫Œ±Œπ œÑŒπœÇ Œ≤ŒªŒ¨Œ≤ŒµœÇ œÄŒøœÖ œÄœÅŒøŒæŒµŒΩŒÆŒ∏Œ∑Œ∫Œ±ŒΩ œÉ' Œ±œÖœÑœå.",
                                    size: 22,
                                    font: "Arial"
                                })
                            ],
                            alignment: AlignmentType.JUSTIFIED
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "Œ§Œø œÄŒ±œÅœåŒΩ ŒºŒπœÉŒ∏œâœÑŒÆœÅŒπŒø Œ¥ŒπŒ±Œ≤Œ¨œÉœÑŒ∑Œ∫Œµ Œ∫Œ±Œπ Œ≠Œ≥ŒπŒΩŒµ Œ±œÄŒøŒ¥ŒµŒ∫œÑœå Œ±œÄœå œÑŒøœçœÇ œÉœÖŒºŒ≤Œ±ŒªŒªŒøŒºŒ≠ŒΩŒøœÖœÇ, œÖœÄŒøŒ≥œÅŒ¨œÜŒ∑ Œ±œÄœå Œ±œÖœÑŒøœçœÇ Œ∫Œ±Œπ Œø Œ∫Œ±Œ∏Œ≠ŒΩŒ±œÇ Œ≠ŒªŒ±Œ≤Œµ Œ±œÄœå Œ≠ŒΩŒ± œåŒºŒøŒπŒø Œ±ŒΩœÑŒØœÑœÖœÄŒø.",
                                    size: 22,
                                    font: "Arial"
                                })
                            ],
                            alignment: AlignmentType.JUSTIFIED
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "                                   ",
                                    size: 22,
                                    font: "Arial"
                                })
                            ],
                            alignment: AlignmentType.JUSTIFIED
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "                                   ",
                                    size: 22,
                                    font: "Arial"
                                })
                            ],
                            alignment: AlignmentType.JUSTIFIED
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "ŒüŒô Œ£Œ•ŒúŒíŒëŒõŒõŒüŒúŒïŒùŒüŒô",
                                    bold: true,
                                    size: 22,
                                    font: "Arial"
                                })
                            ],
                            alignment: AlignmentType.JUSTIFIED
                        }),
                        new Table({
                            width: { size: 100, type: WidthType.PERCENTAGE },
                            borders: {
                                top: { style: BorderStyle.NONE, size: 0 },
                                bottom: { style: BorderStyle.NONE, size: 0 },
                                left: { style: BorderStyle.NONE, size: 0 },
                                right: { style: BorderStyle.NONE, size: 0 }
                            },
                            rows: [
                                new TableRow({
                                    children: [
                                        new TableCell({
                                            width: { size: 50, type: WidthType.PERCENTAGE },
                                            children: [
                                                new Paragraph({
                                                    children: [
                                                        new TextRun({
                                                            text: `ŒòŒïŒ©Œ°ŒóŒòŒóŒöŒï Œ§Œü ŒìŒùŒóŒ£ŒôŒü Œ§ŒóŒ£ Œ•Œ†ŒüŒìŒ°ŒëŒ¶ŒóŒ£
                                                            ŒïŒöŒúŒôŒ£ŒòŒ©Œ§ŒóŒ£ ${agreement.owner.full_name}\n
                                                                ŒºŒµ Œë.Œî.Œ§.:________________`,
                                                            size: 20,
                                                            font: "Arial"
                                                        })
                                                    ],
                                                    alignment: AlignmentType.CENTER
                                                })
                                            ]
                                        }),
                                        new TableCell({
                                            width: { size: 50, type: WidthType.PERCENTAGE },
                                            children: [
                                                new Paragraph({
                                                    children: [
                                                        new TextRun({
                                                            text: `ŒòŒïŒ©Œ°ŒóŒòŒóŒöŒï Œ§Œü ŒìŒùŒóŒ£ŒôŒü Œ§ŒóŒ£ Œ•Œ†ŒüŒìŒ°ŒëŒ¶ŒóŒ£
                                                            ŒúŒôŒ£ŒòŒ©Œ§ŒóŒ£ ${tenant.first_name || 'Unknown'} ${tenant.last_name || 'Tenant'} ${tenant.father_name ? 'œÑŒøœÖ ' + tenant.father_name : ''}\n 
                                                                ŒºŒµ Œë.Œî.Œ§.:${tenant.identity_number || '-'}`,
                                                            size: 20,
                                                            font: "Arial"
                                                        })
                                                    ],
                                                    alignment: AlignmentType.CENTER
                                                })
                                            ]
                                        })
                                    ]
                                })
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "                                   ",
                                    size: 22,
                                    font: "Arial"
                                })
                            ],
                            alignment: AlignmentType.JUSTIFIED
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "                                   ",
                                    size: 22,
                                    font: "Arial"
                                })
                            ],
                            alignment: AlignmentType.JUSTIFIED
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "                                   ",
                                    size: 22,
                                    font: "Arial"
                                })
                            ],
                            alignment: AlignmentType.JUSTIFIED
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "                                   ",
                                    size: 22,
                                    font: "Arial"
                                })
                            ],
                            alignment: AlignmentType.JUSTIFIED
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "                                   ",
                                    size: 22,
                                    font: "Arial"
                                })
                            ],
                            alignment: AlignmentType.JUSTIFIED
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "                                   ",
                                    size: 22,
                                    font: "Arial"
                                })
                            ],
                            alignment: AlignmentType.JUSTIFIED
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "                                   ",
                                    size: 22,
                                    font: "Arial"
                                })
                            ],
                            alignment: AlignmentType.JUSTIFIED
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "ŒìŒπŒ± œÑŒø Œ≥ŒΩŒÆœÉŒπŒø œÑœâŒΩ œÖœÄŒøŒ≥œÅŒ±œÜœéŒΩ",
                                    size: 22,
                                    font: "Arial"
                                })
                            ],
                            alignment: AlignmentType.JUSTIFIED
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "ŒóŒúŒïŒ°ŒüŒúŒóŒùŒôŒë: 1Œ∑ ŒùŒøŒµŒºŒ≤œÅŒØŒøœÖ 2024",
                                    size: 20,
                                    font: "Arial"
                                })
                            ],
                            alignment: AlignmentType.JUSTIFIED
                        })
                    ]
                }]
            });

            return docx.Packer.toBlob(doc).then(blob => {
                const filename = `Agreement_${agreement.owner.tin}_${agreement.owner.full_name}_${agreement.rental_start_date || 'no_date'}.docx`;
                if (storeBlob) {
                    agreementBlobs.push({ blob, filename });
                } else {
                    saveAs(blob, filename);
                }
                console.log('Document generated successfully:', filename);
            }).catch(error => {
                console.error('Document Generation Error:', error);
                throw error;
            });
        }

        function downloadAllAgreements() {
            if (!window.JSZip || agreementBlobs.length === 0) {
                showError('Unable to download all agreements. JSZip not loaded or no agreements generated.');
                console.error('Download All Failure:', { JSZip: !!window.JSZip, agreementBlobsLength: agreementBlobs.length });
                return;
            }

            const zip = new JSZip();
            agreementBlobs.forEach((item) => {
                zip.file(item.filename, item.blob);
            });

            zip.generateAsync({ type: 'blob' }).then(content => {
                saveAs(content, `All_Agreements_${new Date().toISOString().slice(0, 10)}.zip`);
                console.log('All agreements downloaded as ZIP.');
                agreementBlobs = [];
                downloadAllBtn.style.display = 'none';
                agreementCounter.textContent = 'Agreements: 0';
            }).catch(error => {
                showError('Error creating ZIP file: ' + error.message);
                console.error('ZIP Generation Error:', error);
            });
        }

        // Right Panel Functions - PDF Combiner
        function handlePdfSelection(event) {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                addPDFFiles(files);
            }
        }

        function addPDFFiles(files) {
            files.forEach(file => {
                if (file.type === 'application/pdf') {
                    selectedPDFs.push(file);
                }
            });
            updatePdfFilesList();
            updateCombineButton();
        }

        function updatePdfFilesList() {
            pdfFilesList.innerHTML = '';
            
            if (selectedPDFs.length === 0) {
                pdfFilesList.innerHTML = '<p style="color: #666; text-align: center; font-style: italic;">No PDF files selected</p>';
                return;
            }

            selectedPDFs.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'pdf-file-item';
                
                const fileInfo = document.createElement('div');
                fileInfo.className = 'pdf-file-info';
                
                const fileName = document.createElement('div');
                fileName.className = 'pdf-file-name';
                fileName.textContent = file.name;
                
                const fileSize = document.createElement('div');
                fileSize.className = 'pdf-file-size';
                fileSize.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
                
                fileInfo.appendChild(fileName);
                fileInfo.appendChild(fileSize);
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-pdf-btn';
                removeBtn.innerHTML = '√ó';
                removeBtn.title = 'Remove file';
                removeBtn.onclick = () => removePdfFile(index);
                
                fileItem.appendChild(fileInfo);
                fileItem.appendChild(removeBtn);
                pdfFilesList.appendChild(fileItem);
            });
        }

        function removePdfFile(index) {
            selectedPDFs.splice(index, 1);
            updatePdfFilesList();
            updateCombineButton();
        }

        function updateCombineButton() {
            combineBtn.disabled = selectedPDFs.length < 2;
            combineBtn.textContent = selectedPDFs.length < 2 ? 
                'Select at least 2 PDFs to combine' : 
                `Combine ${selectedPDFs.length} PDFs`;
        }

        function showProgress(percent) {
            progressBar.style.display = 'block';
            progressFill.style.width = `${percent}%`;
        }

        function hideProgress() {
            progressBar.style.display = 'none';
            progressFill.style.width = '0%';
        }

        async function combinePDFs() {
            if (!window.PDFLib || selectedPDFs.length < 2) {
                showPdfError('PDF-lib not available or not enough files selected.');
                return;
            }

            try {
                hidePdfError();
                combineBtn.disabled = true;
                combineBtn.textContent = 'Combining PDFs...';
                showProgress(10);

                const { PDFDocument } = PDFLib;
                const combinedPdf = await PDFDocument.create();
                
                for (let i = 0; i < selectedPDFs.length; i++) {
                    const file = selectedPDFs[i];
                    showProgress(10 + (i / selectedPDFs.length) * 80);
                    
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await PDFDocument.load(arrayBuffer);
                    const pages = await combinedPdf.copyPages(pdf, pdf.getPageIndices());
                    
                    pages.forEach(page => combinedPdf.addPage(page));
                }

                showProgress(95);
                
                const combinedPdfBytes = await combinedPdf.save();
                const blob = new Blob([combinedPdfBytes], { type: 'application/pdf' });
                
                const filename = `Combined_PDF_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.pdf`;
                saveAs(blob, filename);
                
                showProgress(100);
                
                // Reset after successful combination
                setTimeout(() => {
                    hideProgress();
                    selectedPDFs = [];
                    updatePdfFilesList();
                    updateCombineButton();
                    combineBtn.textContent = 'Select at least 2 PDFs to combine';
                    
                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = `
                        background: rgba(76, 175, 80, 0.1);
                        border: 1px solid #4CAF50;
                        border-radius: 8px;
                        padding: 15px;
                        margin: 15px 0;
                        color: #2e7d32;
                        text-align: center;
                        font-weight: bold;
                    `;
                    successMsg.textContent = `‚úÖ Successfully combined ${selectedPDFs.length} PDFs!`;
                    pdfFilesList.appendChild(successMsg);
                    
                    setTimeout(() => {
                        if (successMsg.parentNode) {
                            successMsg.parentNode.removeChild(successMsg);
                        }
                    }, 3000);
                }, 500);
                
            } catch (error) {
                console.error('PDF Combination Error:', error);
                showPdfError('Error combining PDFs: ' + error.message);
                hideProgress();
                combineBtn.disabled = false;
                updateCombineButton();
            }
        }
